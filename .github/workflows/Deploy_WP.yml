name: "üöÄ Deploy to WP Engine"

on:
    workflow_call:
        inputs:
            staging_environment_name:
                description: The name of the staging environment in WP Engine.
                required: true
                type: string
            production_environment_name:
                description: The name of the production environment in WP Engine.
                required: true
                type: string
            node_version:
                description: The required version of node passed from the caller workflow.
                required: true
                type: string
            src_path:
                description: Optional path to specify a directory within the repo to deploy from. Ex. "wp-content/themes/soar/". Defaults to root of repo filesystem as source.
                required: false
                default: .\
                type: string
            remote_path:
                description: Optional path to specify a directory destination to deploy to. Ex. "wp-content/themes/soar/". Defaults to WordPress root directory on WP Engine.
                required: false
                default: .\
                type: string
            rsync_flags:
                description: Optional rsync flags such as '--delete' or '--exclude-from'. '-a' preserves symbolic links, timestamps, user permissions and ownership. '-z' is for compression. '-v' is for verbose output. '-r' is for recursive directory scanning. Defaults to '-azvr --inplace --delete --exclude-from=exclude.txt'.
                required: false
                default: -azvr --inplace --delete --exclude-from=exclude.txt
                type: string
            
defaults:
    run:
        shell: pwsh

env:
    STAGING_SITE_NAME: ${{ inputs.staging_environment_name }}
    PRODUCTION_SITE_NAME: ${{ inputs.production_environment_name }}

jobs:
    Deploy:
        runs-on: ubuntu-latest
        steps:
          - name: "üöö Get Latest Code"
            uses: actions/checkout@v3
          - name: ‚öôÔ∏è Use Node.js ${{ inputs.node_version }}
            uses: actions/setup-node@v2
            with:
                node-version: ${{ inputs.node_version }}
          - name: "üõ†Ô∏è Build"
            run: |
                npm ci
                npm run build
          - name: "ü•∑ Conditional WPEngine environment"
            if: github.event_name != 'workflow_dispatch'
            uses: haya14busa/action-cond@v1.0.0
            id: environment
            with:
                cond: ${{ github.ref_name == 'production' }}
                if_true: ${{ env.PRODUCTION_SITE_NAME }}
                if_false: ${{ env.STAGING_SITE_NAME }}
          - name: Deploy to WP Engine - ${{ steps.environment.outputs.value || env.STAGING_SITE_NAME }}
            uses: wpengine/github-action-wpe-site-deploy@v3
            with:
                WPE_SSHG_KEY_PRIVATE: ${{ secrets.WPE_SSHG_KEY_PRIVATE }}
                WPE_ENV: ${{ steps.environment.outputs.value || env.STAGING_SITE_NAME }}
                SRC_PATH: ${{ inputs.src_path }}
                REMOTE_PATH: ${{ inputs.remote_path }}
                FLAGS: ${{ inputs.rsync_flags }}
                CACHE_CLEAR: TRUE