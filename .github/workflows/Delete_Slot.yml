name: "üöÄ Deploy"

on:
    workflow_call:
        inputs:
            project_name:
                description: "The name of the project passed from the caller workflow. You should include '.Web', '.Admin', etc., but NOT '.csproj'"
                required: true
                type: string
            octopus_project_name:
                description: 'The Octopus Deploy project name passed from the caller workflow'
                required: true
                type: string
            is_pci:
                description: 'Boolean value for whether or not the caller workflow is a PCI application repository'
                default: false
                required: false
                type: boolean

defaults:
    run:
        shell: pwsh

env:
    OCTOPUS_API_KEY: ${{ secrets.OCTOPUS_API_KEY }}
    OCTOPUS_URL: ${{ secrets.OCTOPUS_SERVER_URL }}
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
jobs:
  Env:
    name: üíÅ Environment Variables
    runs-on: self-hosted
    steps:
    - name: Print Environment Variables
      run: "gci env:"
  Version:
    name: üè∑ Version Step
    outputs:
      new_tag: ${{ steps.version.outputs.new_tag }}
      new_version: ${{ steps.version.outputs.new_version }}
      previous_tag: ${{ steps.version.outputs.tag }}
      previous_version: ${{ steps.version.outputs.version }}
      project_version: ${{ steps.get_version.outputs.PROJECT_VERSION }}
    runs-on: ubuntu-latest
    steps:
    - name: üöö Get Latest Code
      uses: actions/checkout@v3
      with:
        fetch-depth: "0"
    - name: ü§© GitHub Environment Variables Action
      uses: FranzDiebold/github-env-vars-action@v2
    - name: üêô Run Runbook to Delete Deployment Slot
      uses: OctopusDeploy/run-runbook-action@v3
      with:
        project: 'Automation Tools'
        runbook: 'Remove A Deployment Slot'
        environments: "Azure - Dev,Azure - Test"
        variables: |
          SlotName=${{ inputs.slot_name }}
        space: Web